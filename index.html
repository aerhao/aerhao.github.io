<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>AI HPC in doing we learn!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="AI HPC in doing we learn!">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="AI HPC in doing we learn!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="zhangdonghao678@163.com">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="AI HPC in doing we learn!" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">AI HPC in doing we learn!</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-CentOS7_install_Slurm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/08/05/CentOS7_install_Slurm/" class="article-date">
  <time datetime="2022-08-04T16:28:37.841Z" itemprop="datePublished">2022-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/05/CentOS7_install_Slurm/">CentOS7.9安装Slurm计算调度集群</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">服务器配置：</span><br><span class="line">1个管理节点control，多个计算节点c1、c2</span><br><span class="line">sda盘安装操作系统标准分区</span><br><span class="line">sdb盘*T，可以挂载/home目录，普通用户家目录使用</span><br><span class="line"></span><br><span class="line">安装系统：CentOS（英文版）</span><br><span class="line"><span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.9.2009 (Core)</span><br><span class="line"><span class="comment"># uname -r</span></span><br><span class="line">3.10.0-1160.el7.x86_64</span><br><span class="line"></span><br><span class="line">安装软件：NIS、NFS、NTP</span><br><span class="line">Slurm作业管理系统slurm-22.05.2.tar</span><br><span class="line">munge-0.5.15.tar</span><br><span class="line">mysql80-community-release-el7-6.noarch</span><br></pre></td></tr></table></figure>

<h6 id="1、-安装操作系统"><a href="#1、-安装操作系统" class="headerlink" title="1、 安装操作系统"></a>1、 安装操作系统</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ventoy+CentOS7.9</span><br></pre></td></tr></table></figure>

<h6 id="2、-配置网络、主机名、ssh免密"><a href="#2、-配置网络、主机名、ssh免密" class="headerlink" title="2、 配置网络、主机名、ssh免密"></a>2、 配置网络、主机名、ssh免密</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ifconfig-ens33是当前的网络连接名</span></span><br><span class="line">vi /etc/sysconfig/network-script/ifconfig-ens33</span><br><span class="line">将onboot=no =&gt; onboot=<span class="built_in">yes</span></span><br><span class="line"><span class="comment">#重启网络服务</span></span><br><span class="line">service network restart</span><br></pre></td></tr></table></figure>

<p>安装net-tools工具方便查看ip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum search net-tools</span><br><span class="line">yum install net-tools</span><br><span class="line">ifconfig查看ip</span><br></pre></td></tr></table></figure>

<p>关闭防火墙、selinux、NetworkManager</p>
<p>修改名称，改的名称和映射地址的名称一致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hostname</span><br></pre></td></tr></table></figure>

<p>修改hosts文件地址映射主机名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="comment">#添加（以实际ip为准，control是控制器名称，c1、c2是两台计算节点名称，名称自己定）</span></span><br><span class="line">192.168.1.1 control</span><br><span class="line">192.168.1.2 c1</span><br><span class="line">192.168.1.3 c2</span><br></pre></td></tr></table></figure>

<p>配置ssh免密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl openssh-server –y</span><br><span class="line"><span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">设置PermitRootLogin=<span class="built_in">yes</span></span><br><span class="line">设置PasswordAuthentication=<span class="built_in">yes</span></span><br><span class="line">设置PubkeyAuthentication=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 生成公私密匙对</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub user@server</span><br></pre></td></tr></table></figure>

<p>使用nopasswd脚本配置双向免密</p>
<h6 id="3、-NFS共享存储"><a href="#3、-NFS共享存储" class="headerlink" title="3、 NFS共享存储"></a>3、 NFS共享存储</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils rpcbind –y</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-server</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-lock</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-idmap</span><br><span class="line"><span class="comment">#enble换成start来开启服务</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line"><span class="comment">#添加 /home 192.168.145.0/24(rw,sync,no_root_squash) </span></span><br></pre></td></tr></table></figure>

<p>#使配置生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -a</span><br></pre></td></tr></table></figure>

<p>共享/home文件夹</p>
<p>客户端挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils -y</span><br></pre></td></tr></table></figure>

<p>#检查服务器共享目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 服务器地址</span><br></pre></td></tr></table></figure>

<p>#开机挂载共享存储</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rc.local</span><br><span class="line"><span class="comment">#添加 </span></span><br><span class="line">mount -t nfs 服务器地址:目录 客户端目</span><br></pre></td></tr></table></figure>

<h6 id="4、-配置NIS"><a href="#4、-配置NIS" class="headerlink" title="4、 配置NIS"></a>4、 配置NIS</h6><p>服务端安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ypserv ypbind yp-tools</span><br><span class="line">yum -y install setup*</span><br></pre></td></tr></table></figure>

<p>设置NIS开机自启动和现在启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> ypserv</span><br><span class="line">systemctl <span class="built_in">enable</span> yppasswdd</span><br><span class="line">systemctl start ypserv</span><br><span class="line">systemctl start yppasswdd</span><br><span class="line">systemctl status ypserv</span><br><span class="line"></span><br><span class="line">rpcinfo -u control ypserv </span><br></pre></td></tr></table></figure>

<p>NIS服务端初始化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib64/yp/ypinit –m</span><br></pre></td></tr></table></figure>

<p>之后输入“Ctrl+D”继续执行命令，输入y</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib64/yp/ypinit -s control</span><br></pre></td></tr></table></figure>

<p>每次开机时都需要启动这个nis域名的话，直接把它写入/etc/rc.d/rc.local中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/bin/nisdomainname TS10K&quot;</span> &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure>

<p>我们在服务端新增加了用户数据，需要在/var/yp下执行make，否则客户端看不到用户信息。</p>
<p>客户端安装                   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ypserv ypbind yp-tools</span><br><span class="line">yum -y install setup*</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;NISDOMAIN=TS10K&quot;</span> &gt;&gt; /etc/sysconfig/network</span><br><span class="line">setup</span><br><span class="line"><span class="comment">#配置USE NIS</span></span><br></pre></td></tr></table></figure>

<p>在客户端的/etc/yp.conf中添加”domain TS10K server control”</p>
<p>开启ypbind，并设置开机自启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> ypbind</span><br><span class="line">systemctl start ypbind</span><br><span class="line">systemctl status ypbind</span><br></pre></td></tr></table></figure>

<p>创建普通用户登录做登录测试验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usetadd test3</span><br><span class="line">passwd test3</span><br></pre></td></tr></table></figure>

<p>创建新用户或更改用户组等信息，则只需在control更新NIS即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/yp</span><br><span class="line">make</span><br><span class="line">su test3</span><br><span class="line"><span class="comment">#配置普通用户免密登录集群计算节点</span></span><br><span class="line"><span class="built_in">cd</span> /opt/nopasswd/</span><br><span class="line">./nopasswduser </span><br></pre></td></tr></table></figure>

<p>执行上述操作后，client端才能同步到最新用户信息。</p>
<h6 id="5、-安装munge（管理节点和计算节点）"><a href="#5、-安装munge（管理节点和计算节点）" class="headerlink" title="5、 安装munge（管理节点和计算节点）"></a>5、 安装munge（管理节点和计算节点）</h6><p>#安装rpm构建工具，用来构建rpm安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rpmdevtools</span><br><span class="line">yum install gcc bzip2-devel openssl-devel zlib-devel</span><br></pre></td></tr></table></figure>

<p>通过构建工具生成rpm安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpmbuild -tb --without verify munge-0.5.15.tar.xz</span><br></pre></td></tr></table></figure>

<p>复制代码使用rpm命令安装生成的安装包(构建好的rpm安装包默认在/root/rpbbuild/RPMS/x86_64/)</p>
<p>#安装所有munge rpm包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh munge*</span><br></pre></td></tr></table></figure>

<p>复制代码并生成munge.key</p>
<p>将生成的munge.key拷贝到计算节点/etc/munge，并更改munge.key的归属用户和组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成munge.key</span></span><br><span class="line">mungekey -v</span><br><span class="line"><span class="built_in">chmod</span> 0600 /etc/munge/munge.key</span><br><span class="line"><span class="built_in">chown</span> -R munge.munge /etc/munge/munge.key</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">启动munge服务</span><br><span class="line">systemctl start munge</span><br><span class="line">munge功能测试</span><br><span class="line">munge -n | ssh 客户端主机名 unmunge</span><br></pre></td></tr></table></figure>

<h6 id="6、-安装NTP时间服务器（每台都要）"><a href="#6、-安装NTP时间服务器（每台都要）" class="headerlink" title="6、 安装NTP时间服务器（每台都要）"></a>6、 安装NTP时间服务器（每台都要）</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 安装配置ntp时间同步</span></span><br><span class="line">yum install ntp ntpdate -y</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ntp.conf</span><br><span class="line"><span class="comment"># vim /etc/ntp.conf</span></span><br><span class="line"><span class="comment"># For more information about this file, see the man pages</span></span><br><span class="line"><span class="comment"># ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).</span></span><br><span class="line">driftfile /var/lib/ntp/drift</span><br><span class="line"><span class="comment">#新增:日志目录.</span></span><br><span class="line">logfile /var/log/ntpd.log</span><br><span class="line"><span class="comment"># Permit time synchronization with our time source, but do not</span></span><br><span class="line"><span class="comment"># permit the source to query or modify the service on this system.</span></span><br><span class="line">restrict default nomodify notrap nopeer noquery</span><br><span class="line"><span class="comment"># Permit all access over the loopback interface. This could</span></span><br><span class="line"><span class="comment"># be tightened as well, but to do so would effect some of</span></span><br><span class="line"><span class="comment"># the administrative functions.</span></span><br><span class="line">restrict 127.0.0.1</span><br><span class="line">restrict ::1</span><br><span class="line"><span class="comment">#这一行的含义是授权172.16.128.0网段上的所有机器可以从这台机器上查询和同步时间.</span></span><br><span class="line">restrict 172.16.128.0 mask 255.255.255.0 nomodify notrap</span><br><span class="line"><span class="comment"># Hosts on local network are less restricted.</span></span><br><span class="line"><span class="comment">#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span></span><br><span class="line"><span class="comment"># Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="comment"># Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line"><span class="comment">#server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 3.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#新增:时间服务器列表.</span></span><br><span class="line">server 0.cn.pool.ntp.org iburst</span><br><span class="line">server 1.cn.pool.ntp.org iburst</span><br><span class="line">server 2.cn.pool.ntp.org iburst</span><br><span class="line">server 3.cn.pool.ntp.org iburst </span><br><span class="line"><span class="comment">#新增:当外部时间不可用时，使用本地时间.</span></span><br><span class="line">server 172.16.128.171 iburst</span><br><span class="line">fudge 127.0.0.1 stratum 10</span><br><span class="line"><span class="comment">#broadcast 192.168.1.255 autokey # broadcast server</span></span><br><span class="line"><span class="comment">#broadcastclient # broadcast client</span></span><br><span class="line"><span class="comment">#broadcast 224.0.1.1 autokey # multicast server</span></span><br><span class="line"><span class="comment">#multicastclient 224.0.1.1 # multicast client</span></span><br><span class="line"><span class="comment">#manycastserver 239.255.254.254 # manycast server</span></span><br><span class="line"><span class="comment">#manycastclient 239.255.254.254 autokey # manycast client</span></span><br><span class="line"><span class="comment">#新增:允许上层时间服务器主动修改本机时间.</span></span><br><span class="line">restrict 0.cn.pool.ntp.org nomodify notrap noquery</span><br><span class="line">restrict 1.cn.pool.ntp.org nomodify notrap noquery</span><br><span class="line">restrict 2.cn.pool.ntp.org nomodify notrap noquery</span><br><span class="line"><span class="comment"># Enable public key cryptography.</span></span><br><span class="line"><span class="comment">#crypto</span></span><br><span class="line">includefile /etc/ntp/crypto/pw</span><br><span class="line"><span class="comment"># Key file containing the keys and key identifiers used when operating</span></span><br><span class="line"><span class="comment"># with symmetric key cryptography.</span></span><br><span class="line">keys /etc/ntp/keys</span><br><span class="line"><span class="comment"># Specify the key identifiers which are trusted.</span></span><br><span class="line"><span class="comment">#trustedkey 4 8 42</span></span><br><span class="line"><span class="comment"># Specify the key identifier to use with the ntpdc utility.</span></span><br><span class="line"><span class="comment">#requestkey 8</span></span><br><span class="line"><span class="comment"># Specify the key identifier to use with the ntpq utility.</span></span><br><span class="line"><span class="comment">#controlkey 8</span></span><br><span class="line"><span class="comment"># Enable writing of statistics records.</span></span><br><span class="line"><span class="comment">#statistics clockstats cryptostats loopstats peerstats</span></span><br><span class="line"><span class="comment"># Disable the monitoring facility to prevent amplification attacks using ntpdc</span></span><br><span class="line"><span class="comment"># monlist command when default restrict does not include the noquery flag. See</span></span><br><span class="line"><span class="comment"># CVE-2013-5211 for more details.</span></span><br><span class="line"><span class="comment"># Note: Monitoring will not be disabled with the limited restriction flag.</span></span><br><span class="line"><span class="built_in">disable</span> monitor</span><br></pre></td></tr></table></figure>

<p>复制代码启动ntp服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> ntpd</span><br><span class="line">systemctl start ntpd</span><br></pre></td></tr></table></figure>

<p>#检查是否开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-enabled ntpd</span><br></pre></td></tr></table></figure>

<p>查看ntp连接状态如果没有问题，将正确时间写入硬件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ss -tlunp | grep ntp</span></span><br><span class="line"><span class="comment"># ntpq -p</span></span><br><span class="line"><span class="comment"># hwclock -w</span></span><br></pre></td></tr></table></figure>

<p>ntp客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/ntp.conf</span></span><br><span class="line">server 192.168.111.128</span><br></pre></td></tr></table></figure>

<p>重要：修改任意节点服务器的NTP配置文件都需要重启ntpd服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl restart ntpd</span></span><br></pre></td></tr></table></figure>

<p>以crontab任务计划同步时间（需安装ntpdate，每天24点更新同步时间）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crontab -e</span></span><br><span class="line">0 0 * * * /usr/sbin/sntp -P no -r 192.168.111.128;hwclock -w</span><br></pre></td></tr></table></figure>

<h6 id="7、-安装mysql"><a href="#7、-安装mysql" class="headerlink" title="7、 安装mysql"></a>7、 安装mysql</h6><p>推荐使用rpm安装包方便管理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MySQL8下载地址https://dev.mysql.com/downloads/</span><br></pre></td></tr></table></figure>

<p>注意：一定要安装mysql-community-devel工具，否则slurm会报错找不到accounting_storage_mysql.so</p>
<p>#解压包，cd到目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql-community-&#123;server,client,common,libs,devel&#125;-*</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br><span class="line">mysql -u root -p</span><br><span class="line"><span class="comment">#MySQL8.0安装之后查找默认密码</span></span><br><span class="line">grep <span class="string">&#x27;temporary password&#x27;</span> /var/log/mysqld.log</span><br></pre></td></tr></table></figure>

<p>建立slurm本地连接用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user <span class="string">&#x27;slurm&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;password&#x27;</span></span><br><span class="line"><span class="comment">#授权 如果允许其他节点访问localhost换成节点ip</span></span><br><span class="line">mysql&gt; grant all on slurm_acct_db.* TO <span class="string">&#x27;slurm&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="comment">#创建数据库</span></span><br><span class="line">mysql&gt; create database slurm_acct_db;</span><br></pre></td></tr></table></figure>

<h6 id="8、-安装slurm"><a href="#8、-安装slurm" class="headerlink" title="8、 安装slurm"></a>8、 安装slurm</h6><p>前提：时间同步（ntp），创建slurm用户，用户id和用户组id在各个计算节点一致；在NIS中创建相同ID的slurm；安装了munge；在控制节点和每个计算节点创建同一个用户slurm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd slurm</span><br></pre></td></tr></table></figure>

<p>复制代码slurm下载地址</p>
<p>使用slurm-19.05.5.tar.bz2</p>
<p>安装cgroup插件</p>
<p>#在构建rpm前安装好hwloc,在安装slurm后需要配置cgroup.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install hwloc</span><br></pre></td></tr></table></figure>

<p>复制代码构建slurm rpm安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpmbuild -ta slurm-22.05.2.tar.bz2</span><br></pre></td></tr></table></figure>

<p>复制代码构建是可能会提示需要某个依赖，安装依赖后重新构建</p>
<p>#进到生成的rpm包目录，安装所有slurm rpm包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install slurm*</span><br></pre></td></tr></table></figure>

<p>配置好后将slurm.conf 复制到计算节点，常规位置在:/etc/slurm/</p>
<p>cat slurm.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Minimal slurm.conf file for sigle Linux node</span></span><br><span class="line"><span class="comment"># Replace &quot;HOSTNAME&quot; with computer&#x27;s name (&quot;hostname -s&quot;)</span></span><br><span class="line"><span class="comment"># Replace &quot;USER&quot; with your user name (&quot;id -un&quot;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">ControlMachine=control       <span class="comment">#更改为管理节点主机名&quot;HOSTNAME&quot;</span></span><br><span class="line">ControlAddr=192.168.111.128  <span class="comment">#更改为管理节点的ip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#AuthType=auth/munge</span></span><br><span class="line">MailProg=/usr/local/bin/mail</span><br><span class="line">ClusterName=jackclu</span><br><span class="line">CryptoType=crypto/munge</span><br><span class="line">JobAcctGatherType=jobacct_gather/none</span><br><span class="line">JobCompType=jobcomp/none</span><br><span class="line">MpiDefault=none</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">MCSPlugin=mcs/account</span><br><span class="line">MCSParameters=enforced,select,privatedata</span><br><span class="line"></span><br><span class="line">ProctrackType=proctrack/pgid</span><br><span class="line">ReturnToService=1</span><br><span class="line"><span class="comment">#SallocDefaultCommand=&quot;/usr/local/bin -n1 -N1 --pty --preserve-env --mpi=none $SHELL&quot;</span></span><br><span class="line">SchedulerType=<span class="built_in">sched</span>/backfill</span><br><span class="line"><span class="comment">#SchedulerPort=7321</span></span><br><span class="line">SelectType=select/cons_res</span><br><span class="line">SelectTypeParameters=CR_CPU</span><br><span class="line">SlurmctldDebug=3</span><br><span class="line">SlurmctldLogFile=/opt/slurm/log/slurmctld.log <span class="comment">#创建文件夹/opt/slurm/log/和slurmctld.log文件</span></span><br><span class="line">SlurmctldPidFile=/opt/slurm/pid/slurmctld.pid</span><br><span class="line">SlurmctldPort=6817</span><br><span class="line">SlurmdPidFile=/opt/slurm/pid/slurmd.pid</span><br><span class="line">SlurmdDebug=3</span><br><span class="line">SlurmdLogFile=/opt/slurm/log/slurmd.log</span><br><span class="line">SlurmdPort=6818</span><br><span class="line">SlurmdSpoolDir=/opt/slurm/slurmd.state</span><br><span class="line"><span class="comment">#SlurmUser=slurmAdmin                         # CHANGE &quot;USER&quot;</span></span><br><span class="line"><span class="comment">#SlurmdUser=slurmAdmin                        # CHANGE &quot;USER&quot;</span></span><br><span class="line">StateSaveLocation=/opt/slurm/slurmctld.state</span><br><span class="line">SwitchType=switch/none</span><br><span class="line"><span class="comment">#配置记账</span></span><br><span class="line">AccountingStorageHost=127.0.0.1               <span class="comment">#数据库位置</span></span><br><span class="line"><span class="comment">#AccountingStoragePass=</span></span><br><span class="line">AccountingStoragePort=6819</span><br><span class="line">AccountingStorageType=accounting_storage/slurmdbd</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># COMPUTE NODES 计算节点信息</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># CHANGE &quot;HOSTNAME&quot;</span></span><br><span class="line">NodeName=control CPUs=2 Boards=1 SocketsPerBoard=2 CoresPerSocket=1 ThreadsPerCore=1 RealMemory=1000</span><br><span class="line">NodeName=c[1-2] CPUs=2 Boards=1 SocketsPerBoard=2 CoresPerSocket=1 ThreadsPerCore=1 RealMemory=1000</span><br><span class="line">PartitionName=debug Nodes=c[1-2],control Default=YES MaxTime=INFINITE State=UP    </span><br><span class="line"><span class="comment"># CHANGE &quot;HOSTNAME&quot;</span></span><br></pre></td></tr></table></figure>

<p>cat slurmdbd.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example slurmdbd.conf file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See the slurmdbd.conf man page for more information.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Archive info</span></span><br><span class="line"><span class="comment">#ArchiveJobs=yes</span></span><br><span class="line"><span class="comment">#ArchiveDir=&quot;/tmp&quot;</span></span><br><span class="line"><span class="comment">#ArchiveSteps=yes</span></span><br><span class="line"><span class="comment">#ArchiveScript=</span></span><br><span class="line"><span class="comment">#JobPurge=12</span></span><br><span class="line"><span class="comment">#StepPurge=1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Authentication info</span></span><br><span class="line">AuthType=auth/munge</span><br><span class="line">AuthInfo=/var/run/munge/munge.socket.2</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># slurmDBD info</span></span><br><span class="line">Dbdaddr=127.0.0.1</span><br><span class="line">DbdHost=localhost</span><br><span class="line">DbdPort=6819</span><br><span class="line">SlurmUser=slurm</span><br><span class="line"><span class="comment">#MessageTimeout=300</span></span><br><span class="line">DebugLevel=verbose</span><br><span class="line"><span class="comment">#DefaultQOS=normal,standby</span></span><br><span class="line">LogFile=/opt/slurm/log/slurmdbd.log</span><br><span class="line">PidFile=/opt/slurm/log/slurmdbd.pid</span><br><span class="line"><span class="comment">#PluginDir=/usr/lib/slurm</span></span><br><span class="line"><span class="comment">#PrivateData=accounts,users,usage,jobs</span></span><br><span class="line"><span class="comment">#TrackWCKey=yes</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Database info</span></span><br><span class="line">StorageType=accounting_storage/mysql</span><br><span class="line"><span class="comment">#数据库信息</span></span><br><span class="line">StorageHost=127.0.0.1</span><br><span class="line">StoragePort=3306</span><br><span class="line">StoragePass=Inspur1!     <span class="comment">#修改为slurm账户登录MySQL8密码</span></span><br><span class="line">StorageUser=slurm</span><br><span class="line"><span class="comment">#数据库名称</span></span><br><span class="line">StorageLoc=slurm_acct_db <span class="comment">#MySQL创建对应名称数据库</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#控制节点启动 slurmctld和slurmdbd（数据库在控制主机上）</span></span><br><span class="line"><span class="comment">#计算节点就启动 slurmd</span></span><br><span class="line">systectl start slurmctld</span><br><span class="line">systectl start slurmdbd</span><br><span class="line">systectl start slurmd</span><br><span class="line"><span class="comment">#设置开机启动</span></span><br><span class="line">控制器守护程序: systemctl <span class="built_in">enable</span> slurmctld</span><br><span class="line">数据库守护程序: systemctl <span class="built_in">enable</span> slurmdbd</span><br><span class="line">计算节点守护程序: systemctl <span class="built_in">enable</span> slurmd</span><br><span class="line">systectl status slurmctld</span><br><span class="line">systectl status slurmdbd</span><br><span class="line">systectl status slurmd</span><br><span class="line"><span class="comment">#上述查看服务状态是否running,如果faild排查故障原因</span></span><br><span class="line">running排查错误的过程修改了slurm.conf、slurmdbd.conf配置文件</span><br><span class="line"></span><br><span class="line">例如查看/var/log/messages,slurm日志中出现slurmdbd的错误：</span><br><span class="line">error: Database settings not recommended values: innodb_buffer_pool_size innodb_lock_wait_timeout </span><br><span class="line">解决办法是修改mysql的配置文件/etc/my.cnf，添加innodb_buffer_pool_size和innodb_lock_wait_timeout的大小</span><br><span class="line">[mysqld]</span><br><span class="line"> innodb_buffer_pool_size=1024M</span><br><span class="line"> innodb_log_file_size=64M</span><br><span class="line"> innodb_lock_wait_timeout=900</span><br><span class="line">重启mysqld和slurmdbd后正常运行</span><br></pre></td></tr></table></figure>

<h6 id="9、-测试"><a href="#9、-测试" class="headerlink" title="9、 测试"></a>9、 测试</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@control zhangdonghao]<span class="comment"># cat 1.slurm    #创建slurm脚本任务</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#SBATCH -o job.%j.out</span></span><br><span class="line"><span class="comment">#SBATCH -p debug</span></span><br><span class="line"><span class="comment">#SBATCH --qos=low</span></span><br><span class="line"><span class="comment">#SBATCH -J myFirstJob</span></span><br><span class="line"><span class="comment">#SBATCH --nodes=1</span></span><br><span class="line"><span class="comment">#SBATCH --ntasks-per-node=1</span></span><br><span class="line"></span><br><span class="line">hostname</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@control zhangdonghao]<span class="comment"># cat 2.slurm   #slurm脚本任务示例模板</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#SBATCH --job-name=test              # Job name</span></span><br><span class="line"><span class="comment">#SBATCH --output=test.%j.out    # Stdout (%j expands to jobId)</span></span><br><span class="line"><span class="comment">#SBATCH --error=test.%j.err     # Stderr (%j expands to jobId)</span></span><br><span class="line"><span class="comment">#SBATCH -N 2</span></span><br><span class="line"><span class="comment">#SBATCH -n 3</span></span><br><span class="line"><span class="comment">#SBATCH -p debug</span></span><br><span class="line">hostname</span><br><span class="line"><span class="built_in">date</span></span><br><span class="line"><span class="built_in">sleep</span> 60</span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@control zhangdonghao]<span class="comment"># sbatch 1.slurm</span></span><br><span class="line">[root@control zhangdonghao]<span class="comment"># sbatch 2.slurm</span></span><br><span class="line">[root@control zhangdonghao]<span class="comment"># scontrol update node=c1 state=resume  #重启slurmd服务后修复c1</span></span><br><span class="line">[root@control zhangdonghao]<span class="comment"># scontrol update node=c2 state=resume  #修复c2计算节点</span></span><br><span class="line">[root@control zhangdonghao]<span class="comment"># sinfo       #查看集群</span></span><br><span class="line">PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST</span><br><span class="line">debug*       up   infinite      1    mix control</span><br><span class="line">debug*       up   infinite      1  alloc c1</span><br><span class="line">debug*       up   infinite      1   idle c2</span><br><span class="line">[root@control zhangdonghao]<span class="comment"># squeue      #查看当前任务队列</span></span><br><span class="line">             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)</span><br><span class="line">                19     debug     <span class="built_in">test</span>     root PD       0:00      2 (Resources)</span><br><span class="line">                17     debug     <span class="built_in">test</span>    test3  R       0:13      2 c1,control</span><br><span class="line">[root@control zhangdonghao]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h6 id="10、监控"><a href="#10、监控" class="headerlink" title="10、监控"></a>10、监控</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Grafana+Promethus</span><br></pre></td></tr></table></figure>

<p>计划友情给客户安装一套系统（CPU 内存 硬盘 网卡）监控软件，暂不包含slurm可视化</p>
<h6 id="11、-安装应用程序"><a href="#11、-安装应用程序" class="headerlink" title="11、 安装应用程序"></a>11、 安装应用程序</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MPI编译环境，</span><br><span class="line">ifort（Fortran编译器）</span><br><span class="line">gcc（C语言编译器）</span><br><span class="line">Python3.7（Anaconda版本，加第三方库sklearn、keras、tensorflow2、pytorch等）</span><br><span class="line">matlab软件</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">本实验参考连接：</span><br><span class="line">安装过程笔记</span><br><span class="line">https://juejin.cn/post/6844904065848049672</span><br><span class="line">https://hpc.pku.edu.cn/_book/guide/soft/singularity.html</span><br><span class="line">https://slurm.schedmd.com/configurator.html</span><br><span class="line">https://blog.csdn.net/qq_34149581/article/details/115273509</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/05/CentOS7_install_Slurm/" data-id="cl6f965ln0001eva30wmx4umc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-slurm1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/08/01/slurm1/" class="article-date">
  <time datetime="2022-08-01T11:25:12.059Z" itemprop="datePublished">2022-08-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/01/slurm1/">slurm示例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> test.slurm </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -l</span></span><br><span class="line"><span class="comment">#SBATCH --job-name=test</span></span><br><span class="line"><span class="comment">#SBATCH --partition=cpuPartition</span></span><br><span class="line"><span class="comment">#SBATCH --output=%j.out</span></span><br><span class="line"><span class="comment">#SBATCH --error=%j.err</span></span><br><span class="line"><span class="comment">#SBATCH --nodes=1</span></span><br><span class="line"><span class="comment">#SBATCH --ntasks-per-node=2</span></span><br><span class="line"></span><br><span class="line">srun hostname &gt; ./hostfile.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FI_PROVIDER=sockets</span><br><span class="line"><span class="built_in">source</span> /beegfs/intel2020/compilers_and_libraries/linux/bin/compilervars.sh intel64</span><br><span class="line"><span class="built_in">source</span> /beegfs/intel2020/mkl/bin/mklvars.sh intel64</span><br><span class="line"><span class="built_in">source</span> /beegfs/intel2020/impi/2019.7.217/intel64/bin/mpivars.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$SLURM_NNODES</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$SLURM_NPROCS</span></span><br><span class="line"></span><br><span class="line">PROC=/beegfs/home/zhangdonghao/hello1</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PROC</span></span><br><span class="line"></span><br><span class="line">mpirun -genv I_MPI_FABRICS shm:ofi  -machinefile hostfile.txt -np <span class="variable">$SLURM_NPROCS</span>  <span class="variable">$PROC</span></span><br><span class="line">mpirun hostname</span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf hostfile.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sbatch test.slurm   <span class="comment">#提交任务 </span></span><br><span class="line">Submitted batch job 5960    <span class="comment">#获知任务job id是5960</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sinfo    <span class="comment">#查看分区 </span></span><br><span class="line">PARTITION     AVAIL  TIMELIMIT  NODES  STATE NODELIST</span><br><span class="line">cpuPartition*    up   infinite      1    mix cpu01</span><br><span class="line">cpuPartition*    up   infinite      3  alloc cpu[06-08]</span><br><span class="line">cpuPartition*    up   infinite     12   idle cpu[02-05,09-16]</span><br><span class="line">gpuPartition     up   infinite      1    mix gpu01</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">squeue   <span class="comment">#查看任务</span></span><br><span class="line">JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)</span><br><span class="line">5960 cpuPartit     <span class="built_in">test</span> zhangdon  R       0:05      1 cpu01</span><br><span class="line">squeue </span><br><span class="line">JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> 5960.err   <span class="comment">#查看错误输出</span></span><br><span class="line"><span class="built_in">cat</span> 5960.out   <span class="comment">#查看正确输出</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">/beegfs/home/zhangdonghao/hello1</span><br><span class="line">Hello World from processor cpu01, rank 1 out of 2 processor</span><br><span class="line">Hello World from processor cpu01, rank 0 out of 2 processor</span><br><span class="line">cpu01</span><br><span class="line">cpu01</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/01/slurm1/" data-id="cl6f965of000keva36refeg8i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-PXE_RHEL7.9" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/19/PXE_RHEL7.9/" class="article-date">
  <time datetime="2022-07-18T16:28:01.731Z" itemprop="datePublished">2022-07-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/19/PXE_RHEL7.9/">UEFI模式PXE批量安装RHEL7.9</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>安装步骤<br>1<br>1.1 yum配置本地源<br>　　在/etc/yum.repos.d/下备份所有系统repo文件，并创建新的repo文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">　　[root@mu01~]<span class="comment">#cat &gt; /etc/yum.repos.d/local.repo &lt;&lt;EOF</span></span><br><span class="line">　　[rhel79]</span><br><span class="line">　　name=RedHat7.9</span><br><span class="line">　　baseurl=file:///mnt</span><br><span class="line">　　enabled=1</span><br><span class="line">　　gpgcheck=0</span><br></pre></td></tr></table></figure>

<p>　　然后将iso镜像文件挂载到/mnt下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　　mount –o loop rhel-server-7.9-x86_64-dvd.iso /mnt</span><br></pre></td></tr></table></figure>

<p>2.2 TFTP安装<br>1  yum安装相关包 xinetd tftp tftp-server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install xinetd -y</span><br><span class="line">yum install tftp -y</span><br><span class="line">yum install tftp-server  -y</span><br></pre></td></tr></table></figure>

<p>2  配置tftp服务<br>查看xinetd状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl status xinetd</span></span><br><span class="line">● xinetd.service - Xinetd A Powerful Replacement For Inetd</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/xinetd.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl start xinetd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl status xinetd</span></span><br><span class="line">● xinetd.service - Xinetd A Powerful Replacement For Inetd</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/xinetd.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Mon 2018-03-12 09:43:00 CST; 1s ago</span><br><span class="line">  Process: 6321 ExecStart=/usr/sbin/xinetd -stayalive -pidfile /var/run/xinetd.pid </span><br></pre></td></tr></table></figure>

<p>修改/etc/xinetd.d/tftp文件，将其中的disable=yes改为disable=no。开启TFTP服务<br>-s /var/lib/tftpboot是TFTP服务器的根目录，开启服务。修改后的文件如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default: off</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># description: The tftp server serves files using the trivial file transfer \</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#       protocol.  The tftp protocol is often used to boot diskless \</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#       workstations, download configuration files to network-aware printers, \</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#       and to start the installation process for some operating systems.</span></span><br><span class="line"></span><br><span class="line">service tftp</span><br><span class="line">&#123;</span><br><span class="line">        socket_type             = dgram</span><br><span class="line">        protocol                = udp</span><br><span class="line">        <span class="built_in">wait</span>                    = <span class="built_in">yes</span></span><br><span class="line">        user                    = root</span><br><span class="line">        server                  = /usr/sbin/in.tftpd</span><br><span class="line">        server_args             = -s /var/lib/tftpboot</span><br><span class="line">        <span class="built_in">disable</span>                 = no</span><br><span class="line">        per_source              = 11</span><br><span class="line">        cps                     = 100 2</span><br><span class="line">        flags                   = IPv4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看tftp状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mu01 xinetd.d]<span class="comment"># systemctl status tftp.service</span></span><br><span class="line">● tftp.service - Tftp Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/tftp.service; indirect; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@mu01 ~]<span class="comment"># systemctl start tftp</span></span><br><span class="line">[root@mu01 ~]<span class="comment"># systemctl status tftp</span></span><br><span class="line">● tftp.service - Tftp Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/tftp.service; indirect; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2018-03-12 09:49:43 CST; 1s ago</span><br></pre></td></tr></table></figure>

<p>查看端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost xinetd.d]<span class="comment"># netstat -a|grep tftp                        </span></span><br><span class="line">udp6       0      0 [::]:tftp               [::]:                             </span><br><span class="line">[root@localhost xinetd.d]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>验证服务<br>在/var/lib/tftpboot下vi tt.c,然后通过tftp下载到/home/test目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">　　[root@mu01 tftpboot]<span class="comment"># vi tt.c</span></span><br><span class="line">　　[root@mu01 tftpboot]<span class="comment"># cd /home</span></span><br><span class="line">　　[root@mu01 home]<span class="comment"># mkdir test</span></span><br><span class="line">　　[root@mu01 home]<span class="comment"># cd test</span></span><br><span class="line">　　[root@mu01 <span class="built_in">test</span>]<span class="comment"># tftp 192.168.9.138</span></span><br><span class="line">　　tftp&gt; get tt.c</span><br><span class="line">　　tftp&gt; q</span><br><span class="line">　　[root@mu01 <span class="built_in">test</span>]<span class="comment"># ls</span></span><br><span class="line">　　tt.c</span><br></pre></td></tr></table></figure>

<p>将rhel79.zip解压后，将其中所有文件拷贝到/var/lib/tftpboot下，文件具体信息如下： 注意efidefault需要x权限</p>
<p>2.3 DHCP服务安装<br>1 yum安装dhcp </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install dhcp -y</span><br></pre></td></tr></table></figure>

<p> 配置dhcp服务<br>按照最简配置，复制如下信息到dhcpd.conf文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/dhcp/dhcpd.conf</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DHCP Server Configuration file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   see /usr/share/doc/dhcp/dhcpd.conf.example</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   see dhcpd.conf(5) man page</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">authoritative;</span><br><span class="line">ddns-update-style none;</span><br><span class="line">option user-class <span class="string">&quot;tsddss.hpsd.langchao.com&quot;</span>;</span><br><span class="line">option vendor-class-identifier <span class="string">&quot;tsddss.hpsd.langchao.com&quot;</span>;</span><br><span class="line">default-lease-time 600;</span><br><span class="line">max-lease-time 7200;</span><br><span class="line"></span><br><span class="line">option space PXE; </span><br><span class="line">option PXE.mtftp-ip code 1 = ip-address; </span><br><span class="line">option PXE.mtftp-cport code 2 = unsigned <span class="built_in">integer</span> 16; </span><br><span class="line">option PXE.mtftp-sport code 3 = unsigned <span class="built_in">integer</span> 16;</span><br><span class="line">option PXE.mtftp-tmout code 4 = unsigned <span class="built_in">integer</span> 8; </span><br><span class="line">option PXE.mtftp-delay code 5 = unsigned <span class="built_in">integer</span> 8; </span><br><span class="line">option PXE.discovery-control code 6 = unsigned <span class="built_in">integer</span> 8;</span><br><span class="line">option PXE.discovery-mcast-addr code 7 = ip-address;</span><br><span class="line">option <span class="built_in">arch</span> code 93 = unsigned <span class="built_in">integer</span> 16; </span><br><span class="line">subnet 12.12.12.0 netmask 255.255.255.0 &#123; </span><br><span class="line">	range 12.12.12.1 12.12.12.250;</span><br><span class="line">	next-server 12.12.12.253;</span><br><span class="line">	class <span class="string">&quot;pxeclients&quot;</span> &#123; </span><br><span class="line">		match <span class="keyword">if</span> substring (option vendor-class-identifier, 0, 9) = <span class="string">&quot;PXEClient&quot;</span>; </span><br><span class="line">		<span class="keyword">if</span> option <span class="built_in">arch</span> = 00:02 </span><br><span class="line">		&#123; </span><br><span class="line">			filename <span class="string">&quot;ia64/elilo.efi&quot;</span>; </span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> option <span class="built_in">arch</span> = 00:06 </span><br><span class="line">		&#123; </span><br><span class="line">			filename <span class="string">&quot;X86PC/bootia32.efi&quot;</span>; </span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">if</span> option <span class="built_in">arch</span> = 00:07 </span><br><span class="line">		&#123; </span><br><span class="line"></span><br><span class="line">			filename <span class="string">&quot;BOOTX64.efi&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">		&#123; </span><br><span class="line">			filename <span class="string">&quot;pxelinux.0&quot;</span>; </span><br><span class="line">	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成后重启dhcp服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@mu01 dhcp]<span class="comment"># systemctl start dhcpd</span></span><br><span class="line">[root@mu01 dhcp]<span class="comment"># systemctl status dhcpd</span></span><br><span class="line">● dhcpd.service - DHCPv4 Server Daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2018-03-12 09:58:06 CST; 1min 52s ago</span><br><span class="line">     Docs: man:dhcpd(8)</span><br><span class="line">           man:dhcpd.conf(5)</span><br></pre></td></tr></table></figure>

<p>最后检查dhcp服务状态，67端口开了就表示正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mu01 dhcp]<span class="comment"># netstat -nlp|grep dhcp</span></span><br></pre></td></tr></table></figure>

<p>2.4安装httpd<br>1安装httpd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum istall httpd -y</span><br></pre></td></tr></table></figure>

<p>2 查看状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mu01 dhcp]<span class="comment"># systemctl status httpd</span></span><br><span class="line">● httpd.service - The Apache HTTP Server</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/httpd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@mu01 dhcp]<span class="comment"># systemctl start httpd</span></span><br><span class="line">[root@mu01 dhcp]<span class="comment"># systemctl status httpd</span></span><br><span class="line">● httpd.service - The Apache HTTP Server</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/httpd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2018-03-12 10:13:52 CST; 3s ago</span><br></pre></td></tr></table></figure>

<p>检查http是否可用<br>首先将iso文件挂载到/var/www/html/rhel79下，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mu01 html]<span class="comment"># pwd</span></span><br><span class="line">/var/www/html</span><br><span class="line">[root@mu01 html]<span class="comment"># mkdir rhel79</span></span><br><span class="line">[root@mu01 html]<span class="comment"># mount -o loop rhel-server-7.9-x86_64-dvd.iso /var/www/html/rhel79</span></span><br><span class="line">mount: /dev/loop0 is write-protected, mounting read-only</span><br></pre></td></tr></table></figure>

<p>然后在浏览器输入ip查看挂载的镜像是否可用</p>
<p>同时，将uefi的ks文件拷贝到/var/www/html下，同时根据现场需要修改ks文件内ip及分区信息</p>
<p>如果碰到http无法打开网页的情况，考虑把http目录下关于security的文件备份移动到其他路径（将activated_rules下的所有文件备份到其他目录），重启后重新连接</p>
<p>2.5 PXE安装<br>　　将rhel79.zip压缩包文件解压到ftp根目录，将BOOTX64.efi efidefault跟/pxelinuxcfg/efidefault增加x权限<br>　　rhel79.zip压缩包内有RedHat7.9系统下vmlinuz 和initrd.img文件，如果需要安装7.系统，挂载7.镜像后，将7.系统内的vmlinuz和initrd.img拷贝到tftp根目录下即可<br>efidefault内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@mu01 tftpboot]<span class="comment"># vi /var/lib/tftpboot/pxelinux.cfg/efidefault</span></span><br><span class="line"></span><br><span class="line">default=10</span><br><span class="line"><span class="built_in">timeout</span>=15</span><br><span class="line">splashimage=(nd)/splash.xpm.gz </span><br><span class="line"></span><br><span class="line">lable 10</span><br><span class="line">	title Install RHEL-7.9-x86_64 (UEFI)</span><br><span class="line">	root (nd)</span><br><span class="line">	kernel /vmlinuz ksdevice=<span class="built_in">link</span> ks=http://12.12.12.19/rhel79.cfg  ip=dhcp</span><br><span class="line">	initrd /initrd.img</span><br></pre></td></tr></table></figure>

<p>配置完成后，将客户端BIOS修改为UEFI模式，重启即可开始PXE灌装</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/19/PXE_RHEL7.9/" data-id="cl6f965m50009eva3fmoe2j2y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-rhel7.9.cfg" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/18/rhel7.9.cfg/" class="article-date">
  <time datetime="2022-07-18T14:44:16.920Z" itemprop="datePublished">2022-07-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/18/rhel7.9.cfg/">rhel7.9 PXE安装所用ks文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h6 id="rhel79-cfg"><a href="#rhel79-cfg" class="headerlink" title="rhel79.cfg"></a>rhel79.cfg</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line"></span><br><span class="line">auth --enableshadow --passalgo=sha512</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use CDROM installation media</span></span><br><span class="line"></span><br><span class="line">cdrom</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line"></span><br><span class="line">url --url=<span class="string">&quot;http://12.12.12.19/rhel79&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use graphical install</span></span><br><span class="line"></span><br><span class="line">graphical</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line"></span><br><span class="line">firstboot --<span class="built_in">enable</span></span><br><span class="line">ignoredisk --only-use=sda</span><br><span class="line"></span><br><span class="line"><span class="comment"># Keyboard layouts</span></span><br><span class="line"></span><br><span class="line">keyboard --vckeymap=us --xlayouts=<span class="string">&#x27;us&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line"></span><br><span class="line">lang en_US.UTF-8</span><br><span class="line"></span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line"></span><br><span class="line">network  --bootproto=dhcp --device=ens25f0 --onboot=off --ipv6=auto --no-activate</span><br><span class="line">network  --bootproto=dhcp --device=ens25f1 --onboot=off --ipv6=auto</span><br><span class="line">network  --hostname=localhost.localdomain</span><br><span class="line"></span><br><span class="line">repo --name=<span class="string">&quot;Server-HighAvailability&quot;</span> --baseurl=file:///run/install/repo/addons/HighAvailability</span><br><span class="line">repo --name=<span class="string">&quot;Server-ResilientStorage&quot;</span> --baseurl=file:///run/install/repo/addons/ResilientStorage</span><br><span class="line"></span><br><span class="line"><span class="comment"># Root password</span></span><br><span class="line"></span><br><span class="line">rootpw --iscrypted $6<span class="variable">$ANv</span>./wDwpNsNlbDb<span class="variable">$jMeF8mXZqjGqgq7LjnaZKufBIBH1lsZgqqNk0a8qb1sjmYNwzpRFg</span>/KLqcvSxyDaINYbdQ89BeTDTDXXpRB4A/</span><br><span class="line"></span><br><span class="line"><span class="comment"># System services</span></span><br><span class="line"></span><br><span class="line">services --enabled=<span class="string">&quot;chronyd&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># timezone America/New_York --isUtc</span></span><br><span class="line"></span><br><span class="line">timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># X Window System configuration information</span></span><br><span class="line"></span><br><span class="line">xconfig  --startxonboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line"></span><br><span class="line">bootloader --append=<span class="string">&quot; crashkernel=auto&quot;</span> --location=mbr --boot-drive=sda</span><br><span class="line"></span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line"></span><br><span class="line">clearpart --none --initlabel</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line"></span><br><span class="line">zerombr</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disk partitioning information</span></span><br><span class="line"></span><br><span class="line">part swap --fstype=<span class="string">&quot;swap&quot;</span> --ondisk=sda --size=65536</span><br><span class="line">part / --fstype=<span class="string">&quot;xfs&quot;</span> --ondisk=sda --size=81920</span><br><span class="line">part /var --fstype=<span class="string">&quot;xfs&quot;</span> --ondisk=sda --size=51200</span><br><span class="line">part /tmp --fstype=<span class="string">&quot;xfs&quot;</span> --ondisk=sda --size=20480</span><br><span class="line">part /scr02 --fstype=<span class="string">&quot;xfs&quot;</span> --ondisk=sda --size=695010</span><br><span class="line">part /boot/efi --fstype=<span class="string">&quot;efi&quot;</span> --ondisk=sda --size=512 --fsoptions=<span class="string">&quot;umask=0077,shortname=winnt&quot;</span></span><br><span class="line">part /boot --fstype=<span class="string">&quot;xfs&quot;</span> --ondisk=sda --size=1024</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@^graphical-server-environment</span><br><span class="line">@base</span><br><span class="line">@core</span><br><span class="line">@desktop-debugging</span><br><span class="line">@dial-up</span><br><span class="line">@fonts</span><br><span class="line">@gnome-desktop</span><br><span class="line">@guest-agents</span><br><span class="line">@guest-desktop-agents</span><br><span class="line">@hardware-monitoring</span><br><span class="line">@input-methods</span><br><span class="line">@internet-browser</span><br><span class="line">@multimedia</span><br><span class="line">@print-client</span><br><span class="line">@x11</span><br><span class="line">chrony</span><br><span class="line">kexec-tools</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%addon com_redhat_kdump --<span class="built_in">enable</span> --reserve-mb=<span class="string">&#x27;auto&#x27;</span></span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok</span><br><span class="line">pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> sendmail</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> httpd</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> dhcpd</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> bluetooth</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> iptables</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> ip6tables</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> crd</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> smartd</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> iscsi</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> iscsid</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> rhnsd</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> yum-updatesd</span><br><span class="line">/usr/bin/systemctl <span class="built_in">disable</span> NetworkManager</span><br><span class="line">/usr/bin/systemctl enalbe rsh</span><br><span class="line">/usr/bin/systemctl <span class="built_in">enable</span> rexec</span><br><span class="line">/usr/bin/systemctl <span class="built_in">enable</span> rlogin</span><br><span class="line">/usr/bin/systemctl <span class="built_in">enable</span> cpuspeed</span><br><span class="line">/usr/bin/systemctl <span class="built_in">enable</span> ypbind</span><br><span class="line">/usr/bin/systemctl <span class="built_in">enable</span> portmap</span><br><span class="line">/usr/bin/systemctl <span class="built_in">enable</span> nfs</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;/etc/passwd&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">+::::::</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;/etc/security/limits.conf&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"></span><br><span class="line">*	soft		memlock		unlimited	</span><br><span class="line">*	soft		stack		unlimited	</span><br><span class="line">*	soft		<span class="built_in">nproc</span>		unlimited	</span><br><span class="line">*	hard		memlock		unlimited	</span><br><span class="line">*	hard		stack		unlimited	</span><br><span class="line">*	hard		<span class="built_in">nproc</span>		unlimited		</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line">wget http://12.12.12.19/file_sn -NP /var/</span><br><span class="line"><span class="built_in">cd</span> /var</span><br><span class="line">sn_local=`dmidecode -t system |awk /<span class="string">&quot;Serial Number&quot;</span>/<span class="string">&#x27;&#123;print $3&#125;&#x27;</span>|<span class="built_in">sort</span> -u|sed -e <span class="string">&#x27;s/-//g&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line</span> &gt; ./line</span><br><span class="line">sn=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">ip=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">ip2=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>`</span><br><span class="line">ip3=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>`</span><br><span class="line">host_name=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line">b=`ifconfig |grep en |awk <span class="string">&#x27;NR==1&#x27;</span>|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$sn</span> = <span class="variable">$sn_local</span> ];<span class="keyword">then</span></span><br><span class="line">hostnamectl set-hostname <span class="variable">$host_name</span></span><br><span class="line"><span class="built_in">mv</span> /etc/sysconfig/network-scripts/ifcfg-ens25f0 /etc/sysconfig/network-scripts/ifcfg-ens25f0-bak</span><br><span class="line"><span class="comment">#配置千兆网络</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/sysconfig/network-scripts/ifcfg-ens25f0 &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">NAME=ens25f0</span></span><br><span class="line"><span class="string">DEVICE=ens25f0</span></span><br><span class="line"><span class="string">BOOTPROTO=static</span></span><br><span class="line"><span class="string">ONBOOT=yes</span></span><br><span class="line"><span class="string">TYPE=Ethernet</span></span><br><span class="line"><span class="string">IPADDR=$ip</span></span><br><span class="line"><span class="string">NETMASK=255.255.255.0</span></span><br><span class="line"><span class="string">GATEWAY=12.12.12.254</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#配置infiniband网络</span></span><br><span class="line"><span class="comment">#cat &gt;/etc/sysconfig/network-scripts/ifcfg-ib0 &lt;&lt; EOF</span></span><br><span class="line"><span class="comment">#NAME=ib0</span></span><br><span class="line"><span class="comment">#DEVICE=ib0</span></span><br><span class="line"><span class="comment">#BOOTPROTO=static</span></span><br><span class="line"><span class="comment">#ONBOOT=yes</span></span><br><span class="line"><span class="comment">#TYPE=InfiniBand</span></span><br><span class="line"><span class="comment">#IPADDR=$ip2</span></span><br><span class="line"><span class="comment">#NETMASK=255.255.255.0</span></span><br><span class="line"><span class="comment">#EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############修改IPMI的IP</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipsrc static</span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipaddr <span class="variable">$ip3</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 netmask 255.255.0.0</span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 defgw ipaddr 192.170.255.254</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf /etc/sysconfig/network-scripts/ifcfg-ens25f0-bak</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span> &lt; /var/file_sn</span><br><span class="line"><span class="built_in">rm</span> -rf ./line</span><br><span class="line"><span class="built_in">rm</span> -rf /var/file_sn</span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">/usr/bin/systemctl set-default multi-user.target </span><br><span class="line">/usr/bin/chmod +x /etc/rc.d/rc.local</span><br><span class="line">/usr/bin/chmod +x /etc/rc.local</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /boot/grub/grub.conf /boot/grub/grub.conf-$$</span><br><span class="line">sed -e <span class="string">&#x27;s/rhgb//&#x27;</span> &lt; /boot/grub/grub.conf-$$ &gt; /boot/grub/grub.conf</span><br><span class="line"><span class="built_in">rm</span> -fr /boot/grub/grub.conf-$$</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /etc/inittab /etc/inittab-$$</span><br><span class="line">sed -e <span class="string">&#x27;s/id:5:initdefault:/id:3:initdefault:/&#x27;</span> &lt; /etc/inittab-$$ &gt; /etc/inittab</span><br><span class="line"><span class="built_in">rm</span> -fr /etc/inittab-$$</span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/hosts&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.2.1	n01</span><br><span class="line">192.168.2.2	n02</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#######yum配置</span></span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d /etc/yum.repos.d-bak</span><br><span class="line"><span class="built_in">mkdir</span> /etc/yum.repos.d</span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/yum.repos.d/rhel79.repo&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[rhel79]</span></span><br><span class="line"><span class="string">name=rhel79</span></span><br><span class="line"><span class="string">baseurl=http://12.12.12.19/rhel79</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum repolist</span><br><span class="line">yum -y install ipmitool</span><br><span class="line"></span><br><span class="line">wget http://12.12.12.19/file_sn -NP /var/</span><br><span class="line"><span class="built_in">cd</span> /var</span><br><span class="line">sn_local=`dmidecode -t system |awk /<span class="string">&quot;Serial Number&quot;</span>/<span class="string">&#x27;&#123;print $3&#125;&#x27;</span>|<span class="built_in">sort</span> -u|sed -e <span class="string">&#x27;s/-//g&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line</span> &gt; ./line</span><br><span class="line">sn=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">ip3=`<span class="built_in">cat</span> line | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$sn</span> = <span class="variable">$sn_local</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#############修改IPMI的IP</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipsrc static</span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipaddr <span class="variable">$ip3</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 netmask 255.255.0.0</span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 defgw ipaddr 192.170.255.254</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/sysconfig/network-scripts/ifcfg-ens25f0-bak</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span> &lt; /var/file_sn</span><br><span class="line"><span class="built_in">rm</span> -rf ./line</span><br><span class="line"><span class="built_in">rm</span> -rf /var/file_sn</span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">yum -y install gcc</span><br><span class="line">yum -y install kernel</span><br><span class="line">yum -y install kernel-devel</span><br><span class="line"></span><br><span class="line"><span class="comment">###安装25G驱动</span></span><br><span class="line">yum install gcc*   kernel* -y</span><br><span class="line">查看和添加网卡配置文件</span><br><span class="line">systemctl start NetworkManager</span><br><span class="line">nmcli dev status</span><br><span class="line">nmcli con show</span><br><span class="line"><span class="comment">#nmcli connection add con-name ens21f0 type ethernet ifname ens21f0</span></span><br><span class="line">wget http://12.12.12.19/ice-1.8.8.tar.gz -NP /opt</span><br><span class="line"><span class="built_in">cd</span>  /opt</span><br><span class="line">tar -zxvf ice-1.8.8.tar.gz  -C  /opt</span><br><span class="line"><span class="built_in">cd</span> /opt/ice-1.8.8/src/</span><br><span class="line">make install</span><br><span class="line">dracut --force</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/18/rhel7.9.cfg/" data-id="cl6f965od000jeva34qyr6c58" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-reset_password_root" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/25/reset_password_root/" class="article-date">
  <time datetime="2022-06-24T18:33:50.613Z" itemprop="datePublished">2022-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/25/reset_password_root/">RHEL8重置root管理员密码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>(1）在RHEL ８中，选择“活动”→“终端”命令，然后在打开的终端中输入如下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">Red Hat Enterprise Linux release 8.2 (Ootpa)</span><br></pre></td></tr></table></figure>

<p>(2）在终端输入“reboot”，或者单击右上角的关机按钮 ，选择“重启”按钮，重启Linux系统主机并出现引导界面时，按“e”键进入内核编辑界面。</p>
<p>(3）在linux参数这行的最后面追加“rd.break”参数，然后按下“Ctrl + X”组合键来运行修改过的内核程序。</p>
<p>(4）大约30秒过后，进入系统的紧急救援模式。依次输入以下命令，等待系统重启操作完毕，然后就可以使用新密码来登录Linux系统了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">switch_root:/<span class="comment"># mount -o remount,rw    /sysroot</span></span><br><span class="line">switch_root:/<span class="comment"># chroot   /sysroot</span></span><br><span class="line">sh-4.4<span class="comment"># passwd</span></span><br><span class="line">输入新密码</span><br><span class="line">再次输入新密码</span><br><span class="line">sh-4.4<span class="comment"># exit</span></span><br><span class="line">switch_root:/<span class="comment"># reboot</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/25/reset_password_root/" data-id="cl6f965n6000ieva39o6210mj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IB_8700_setting" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/23/IB_8700_setting/" class="article-date">
  <time datetime="2022-06-23T15:39:25.697Z" itemprop="datePublished">2022-06-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/23/IB_8700_setting/">配置8700 IB交换机</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>串口线连接8700 IB交换机IOIO口（串口），<br>我习惯使用mobax软件使用串口协议，波特率选择115200</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mellanox MLNX-OS Switch Management</span><br><span class="line">switch-9f6fce login: admin</span><br></pre></td></tr></table></figure>

<p>出厂默认密码是admin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Password:</span><br><span class="line">Last login: Mon May 23 08:46:03 on ttyS0</span><br><span class="line">Mellanox Switch</span><br></pre></td></tr></table></figure>

<p>普通模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] &gt;</span><br></pre></td></tr></table></figure>

<p>查看命令帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] &gt; ?</span><br></pre></td></tr></table></figure>

<p>进入特权模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] &gt;<span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

<p>进入配置终端模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] <span class="comment"># configure terminal</span></span><br></pre></td></tr></table></figure>

<p>启动ib 子网管理器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] <span class="comment"># ib sm</span></span><br></pre></td></tr></table></figure>

<p>查看ib 子网管理器是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] (config) <span class="comment"># show ib sm</span></span><br><span class="line"><span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

<p>保存当前运行的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch-9f6fce [standalone: master] (config) <span class="comment"># write memory</span></span><br></pre></td></tr></table></figure>

<p>Mgmt管理口默认是自动获得IP地址，通过dhcp server分配IP地址后用<a target="_blank" rel="noopener" href="https://ip登录/">https://IP登录</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/23/IB_8700_setting/" data-id="cl6f965lt0004eva31qx43qwc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Mattermost_Install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/23/Mattermost_Install/" class="article-date">
  <time datetime="2022-06-23T15:38:20.000Z" itemprop="datePublished">2022-06-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/23/Mattermost_Install/">安装Mattermost预览版本</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基于操作系统CentOS7<br>配置yum源安装docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure>

<p>启动docker和设置开机自启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>

<p>编辑配置文件使用docker镜像加速源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line"><span class="built_in">cat</span> /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;registry-mirrors&quot;</span> : [</span><br><span class="line">   <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">   <span class="string">&quot;http://registry.docker-cn.com&quot;</span>,</span><br><span class="line">   <span class="string">&quot;http://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">   <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span></span><br><span class="line"> ],</span><br><span class="line"> <span class="string">&quot;insecure-registries&quot;</span> : [</span><br><span class="line">   <span class="string">&quot;registry.docker-cn.com&quot;</span>,</span><br><span class="line">   <span class="string">&quot;docker.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line"> ],</span><br><span class="line"> <span class="string">&quot;debug&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"> <span class="string">&quot;experimental&quot;</span> : <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一键安装mattermost-预览镜像，并启动容器映射8065端口到宿主机8065端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mattermost-preview -d --publish 8065:8065 mattermost/mattermost-preview</span><br></pre></td></tr></table></figure>

<p>查看是否启动了docker容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p>浏览器登陆http://宿主机IP:8065/和初始化配置</p>
<p>基于操作系统Ubuntu 20.04 LTS安装Mattermost：（待补充）</p>
<p>云端创建Mattermost资源：（待补充）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/23/Mattermost_Install/" data-id="cl6f965m30008eva38xz8606o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IB_test" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/22/IB_test/" class="article-date">
  <time datetime="2022-06-22T11:59:35.176Z" itemprop="datePublished">2022-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/22/IB_test/">IB网络性能测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>收集ib驱动内置命令各项测试数据、判断IB网络性能<br>在80个计算节点任意选择2个节点，一个节点发送IB网络数据包数据，另一个节点接收数据。<br>查看IB网络收发包网络带宽。<br>在server端执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ib_write_rw -a</span><br></pre></td></tr></table></figure>

<p>在client端执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ib_write_rw -a   对端节点IB网卡IP地址</span><br></pre></td></tr></table></figure>

<p>新的测试方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun -machinefile hostfile -np 80 ./IMB-MPI1 pingpong </span><br></pre></td></tr></table></figure>

<p>手动创建hostfile,并根据节点数量输入np值（相等或者少于均可）；<br>其中IMB-MPI1文件是从intel编译器中cp到测试路径中的；<br>intel2018的测试结果不好；<br>使用intel2020编译器测试出来的效果和ib_write_bw这种点对点测试的一致。<br>IMB-MPI1可执行文件的路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/intel2020/impi/2019.7.217/intel/bin</span><br></pre></td></tr></table></figure>
<p>网络调优：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以通过mellanox提供的工具自动优化</span></span><br><span class="line">mlnx_tune -h</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示当前配置状态</span></span><br><span class="line">mlnx_tune -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#开始优化</span></span><br><span class="line">mlnx_tune -p HIGH_THROUGHPUT</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/22/IB_test/" data-id="cl6f965lz0007eva33xys6uwx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Switch_Deployment_Configuration" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/22/Switch_Deployment_Configuration/" class="article-date">
  <time datetime="2022-06-21T16:12:53.485Z" itemprop="datePublished">2022-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/22/Switch_Deployment_Configuration/">交换机开局基础配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>调测需要使用一根串口线连接主控板卡的[IOIO]口，串口登录选择波特率115200</p>
<h5 id="1-配置ip，开启ssh，增加admin-admin登录账户"><a href="#1-配置ip，开启ssh，增加admin-admin登录账户" class="headerlink" title="1.配置ip，开启ssh，增加admin/admin登录账户"></a>1.配置ip，开启ssh，增加admin/admin登录账户</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Switch&gt; <span class="built_in">enable</span> </span><br><span class="line">Switch<span class="comment"># conf t</span></span><br><span class="line">Switch(config)<span class="comment"># management  ip address  11.11.11.200 255.255.255.0</span></span><br><span class="line">Switch(config)<span class="comment"># exit</span></span><br><span class="line">Switch<span class="comment"># write </span></span><br><span class="line">Switch<span class="comment"># conf t</span></span><br><span class="line">Switch(config)<span class="comment"># ip ssh server enable</span></span><br><span class="line">Switch<span class="comment"># copy r s</span></span><br><span class="line">Switch<span class="comment"># conf t</span></span><br><span class="line">Switch(config)<span class="comment"># username admin privilege 4 password admin</span></span><br><span class="line">Switch(config)<span class="comment"># </span></span><br><span class="line">Switch<span class="comment"># copy r s</span></span><br></pre></td></tr></table></figure>

<p>端口</p>
<h5 id="2-配置端口静态链路聚合"><a href="#2-配置端口静态链路聚合" class="headerlink" title="2.配置端口静态链路聚合"></a>2.配置端口静态链路聚合</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Switch(config)<span class="comment"># interface   range eth-0-1 - 2</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># description to-server-1</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># static-channel-group 1</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># exi</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range eth-0-3 - 4</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># description to-server-2</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># static-channel-group 2</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># exi</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range  eth-0-5 - 6</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># description to-server-3      </span></span><br><span class="line">Switch(config-if-range)<span class="comment"># static-channel-group 3</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># exi</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range  eth-0-7 - 8</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># description to-server-4</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># static-channel-group 4</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># exi</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range  eth-0-9 - 10</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># description to-server-5</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># static-channel-group 5</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># exi</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range  eth-0-11 - 12</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># description to-server-6</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># static-channel-group 6</span></span><br><span class="line">Switch(config-if-range)<span class="comment">#</span></span><br><span class="line">Switch<span class="comment">#</span></span><br><span class="line">Switch<span class="comment"># conf t</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range  agg  1 - 6</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># jumboframe enable</span></span><br><span class="line">Switch(config-if-range)<span class="comment">#</span></span><br><span class="line">Switch<span class="comment">#</span></span><br><span class="line">Switch<span class="comment"># write</span></span><br><span class="line">Building configuration...</span><br><span class="line">[OK]</span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Switch<span class="comment"># conf t</span></span><br><span class="line">Switch(config)<span class="comment"># interface  range  eth-0-1 - 12    </span></span><br><span class="line">Switch(config-if-range)<span class="comment"># no static-channel-group</span></span><br><span class="line">Switch(config-if-range)<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">Switch<span class="comment"># write</span></span><br><span class="line">Building configuration...</span><br><span class="line">[OK]</span><br><span class="line">Switch<span class="comment"># </span></span><br><span class="line">Switch<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h5 id="3-配置动态链路聚合"><a href="#3-配置动态链路聚合" class="headerlink" title="3.配置动态链路聚合"></a>3.配置动态链路聚合</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Switch(config)<span class="comment"># interface range eth-0-3 - 4</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># no jumboframe enable</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># channel-group 2 mode active</span></span><br><span class="line">Switch(config-if-range)<span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Switch(config-if-range)<span class="comment"># no channel-group</span></span><br></pre></td></tr></table></figure>

<h5 id="4-查看链路聚合和配置"><a href="#4-查看链路聚合和配置" class="headerlink" title="4.查看链路聚合和配置"></a>4.查看链路聚合和配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Switch<span class="comment"># show channel-group summary</span></span><br><span class="line">Switch<span class="comment"># show running-config</span></span><br></pre></td></tr></table></figure>

<p>删除agg组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Switch(config)<span class="comment"># no interface agg 2</span></span><br><span class="line">Switch(config)<span class="comment"># no interface agg 3</span></span><br><span class="line">Switch(config)<span class="comment"># no interface agg 4</span></span><br><span class="line">Switch(config)<span class="comment"># no interface agg 5</span></span><br><span class="line">Switch(config)<span class="comment"># no interface agg 7</span></span><br><span class="line">Switch(config)<span class="comment"># no interface agg 6</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/22/Switch_Deployment_Configuration/" data-id="cl6f965m6000aeva38wudgspv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HCA_TO_IB_MODE" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/21/HCA_TO_IB_MODE/" class="article-date">
  <time datetime="2022-06-20T17:25:30.336Z" itemprop="datePublished">2022-06-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/21/HCA_TO_IB_MODE/">Linux操作系统HCA卡切换为 IB 模式：</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mst start</span><br><span class="line">mst status</span><br></pre></td></tr></table></figure>

<p>单口卡：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlxconfig -d /dev/mst/mt4115_pciconf0 <span class="built_in">set</span> LINK_TYPE_P1=ib KEEP_ETH_LINK_UP_P1=1</span><br></pre></td></tr></table></figure>

<p>双口卡：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlxconfig -d /dev/mst/mt4115_pciconf0 <span class="built_in">set</span> LINK_TYPE_P1=ib KEEP_IB_LINK_UP_P1=1 KEEP_IB_LINK_UP_P2=1</span><br></pre></td></tr></table></figure>

<p>切换工作模式后重启服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#reboot</span></span><br></pre></td></tr></table></figure>



<p>备注：</p>
<p>/dev/mst/mt4115_pciconf0   这个名称需要更换成mst status实际看到的/dev设备名</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/21/HCA_TO_IB_MODE/" data-id="cl6f965lq0002eva33494hym8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/05/CentOS7_install_Slurm/">CentOS7.9安装Slurm计算调度集群</a>
          </li>
        
          <li>
            <a href="/2022/08/01/slurm1/">slurm示例</a>
          </li>
        
          <li>
            <a href="/2022/07/19/PXE_RHEL7.9/">UEFI模式PXE批量安装RHEL7.9</a>
          </li>
        
          <li>
            <a href="/2022/07/18/rhel7.9.cfg/">rhel7.9 PXE安装所用ks文件</a>
          </li>
        
          <li>
            <a href="/2022/06/25/reset_password_root/">RHEL8重置root管理员密码</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 zhangdonghao678@163.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>